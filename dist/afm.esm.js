function e(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function t(e="",t=[]){const n=new Map;for(const r of t.values()){const t=e.indexOf(r),s=t+r.length;n.set(r,{start:t,end:s})}return n}function n(e="",t="",n=[],r=0,s={skip:new Map}){const i=Array.from(s.skip.values());let l=0,o=r;if(0===i.length||0===i.filter((e=>r>=e.start&&r<e.end)).length){const r=n.filter((t=>t.includes(e))).map((n=>{const r=t.indexOf(n,l)+n.indexOf(e);return r>l&&(l=r),r}));if(r.includes(o))for(;r.includes(o);)o=t.indexOf(e,o+1)}else o=-1;return o}function r(r="",s="extension",i=((e="")=>e),l={},o={}){const c=r.includes("\r")?"\r\n":"\n",a={skip:new Map,vids:new Map},f=Array.from(new Set(r.match(/\&#\w+;/g)||[])),p=f.map((e=>escape(e))),d=r.split(/(?<!`|>)`{3,3}(?!`)/g).filter(((e,t)=>t%2==1)).map((e=>`\`\`\`${e}\`\`\``)),g=r.match(/\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],u=Object.keys(l).filter((e=>"VIDEO"===l[e]))[0]||"VIDEO";let $=function(e=""){return JSON.parse(JSON.stringify(e))}(r),m=$;a.skip=t($,d);for(const e of d.values())m=m.replace(e,"");const h=Array.from(a.skip.values()),v=m.match(new RegExp(`\\>\\[\\!${u}\\]\\((.*)\\)`,"g"))||[];for(const t of v.values()){const n=Array.from(r.matchAll(new RegExp(e(t),"g"))).filter((e=>{let t=!0;if(a.skip.size>0){const n=e.index;t=0===h.filter((e=>n>=e.start&&n<e.end)).length}return t})).map((e=>({start:e.index,end:e.index+e[0].length})));a.vids.set(t,n)}for(const r of g){let p=r;const g=d.filter((e=>r.includes(e)));if(g.length>0)for(const e of g)p=p.replace(e,`[AFMSKIP]${e.replace(/(^`{3,3}|`{3,3}$)/g,"")}[/AFMSKIP]`);const u=p.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),m=(u[0].match(/\>\[\!(.*)\]/)||[])[1]||"",h=u[1].replace(/\>.*/,""),v=`${c}${h}`,x=`${h}${i(u.slice(1,u.length).map((t=>{let n=t.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const t of f)n.includes(t)&&(n=n.replace(new RegExp(e(t),"g"),escape(t)));return n})).filter(((e,t)=>0!==t||e.length>0)).join(c).trim()).split(/\r?\n/).join(v)}`,w=`<div class="${s} ${(m in l?l[m]:m).toLowerCase().replace(/\s/g,"")}">${v}<div>${m in o?o[m]:m}</div>${v}<div>${c}${x.replace(/\r?\n$/,"").trimEnd()}${v}</div>${v}</div>${v}`;let O=$.indexOf(r);d.length>0&&(O=n(r,$,d,O,a)),O>0&&($=`${$.slice(0,O)}${w}${$.slice(O+r.length)}`,a.skip=t($,d))}for(const e of v){const t=e.replace(/^.*\(|\).*$/g,"");let r=$.indexOf(e);d.length>0&&(r=n(e,$,d,r)),$=`${$.slice(0,r)}<div class="${s} video"><iframe allowfullscreen embedded-video src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${t}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${$.slice(r+e.length)}`}for(const t of p)$=$.replace(new RegExp(e(t),"g"),unescape(t));return $.replace(/\[AFMSKIP\]/g,"<pre><code>").replace(/\[\/AFMSKIP\]/g,"</code></pre>").trim()}export{r as afm};