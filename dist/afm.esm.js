function e(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function t(e="",t="",n=[],r=0){let i=0,l=r;const s=n.filter((t=>t.includes(e))).map((n=>{const r=t.indexOf(n,i)+n.indexOf(e);return r>i&&(i=r),r}));if(s.includes(l))for(;s.includes(l);)l=t.indexOf(e,l+1);return l}function n(n="",r="extension",i=((e="")=>e),l={},s={}){const c=n.includes("\r")?"\r\n":"\n",o=Array.from(new Set(n.match(/\&#\w+;/g)||[])),p=o.map((e=>escape(e))),f=n.split(/(?<!`|>)`{3,3}(?!`)/g),a=f.filter(((e,t)=>t%2==1)).map((e=>`\`\`\`${e.startsWith(c)?"":c}${e}${e.endsWith(c)?"":c}\`\`\``)),d=f.filter(((e,t)=>t%2==0)).map((e=>e.replace(/(^[\r?\n]+|[\r?\n]+$)/g,""))).join(c),$=o.reduce(((t,n)=>t.replace(new RegExp(e(n),"g"),escape(n))),d),g=($.match(/(?!\r?\n)(\s+|\t+)?\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[]).filter((e=>0===a.filter((t=>t.includes(e))).length)),u=Object.keys(l).filter((e=>"VIDEO"===l[e]))[0]||"VIDEO",h=($.match(new RegExp(`\\>\\[\\!${u}\\]\\((.*)\\)`,"g"))||[]).filter((e=>0===a.filter((t=>t.includes(e))).length));let m=function(e=""){return JSON.parse(JSON.stringify(e))}(n);for(const n of g){const f=n.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),d=(f[0].match(/\>\[\!(.*)\]/)||[])[1]||"",$=f[0].replace(/\>\[.*/,""),g=`${c}${$}`,u=`${$}${i(f.slice(1,f.length).map((t=>{let n=t.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const t of o)n.includes(t)&&(n=n.replace(new RegExp(e(t),"g"),escape(t)));return n})).filter(((e,t)=>0!==t||e.length>0)).join(c).trim()).split(/\r?\n/).join(g)}`,h=(d in l?l[d]:d).toLowerCase().replace(/\s/g,""),x=f.map((t=>{let n=t;for(const t of p)n.includes(t)&&(n=n.replace(new RegExp(e(t),"g"),unescape(t)));return n})).join(c);let w=m.indexOf(x);a.length>0&&(w=t(x,m,a,w)),m=`${m.slice(0,w)}${$}<div class="${r} ${h}">${g}<div>${d in s?s[d]:d}</div>${g}<div>${c}${u.replace(/\r?\n$/,"")}${g}</div>${g}</div>${g}${m.slice(w+x.length)}`}for(const e of h){const n=e.replace(/^.*\(|\).*$/g,"");let i=m.indexOf(e);a.length>0&&(i=t(e,m,a,i)),m=`${m.slice(0,i)}<div class="${r} video"><iframe allowfullscreen embedded-video src="${n}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${n}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${m.slice(i+e.length)}`}for(const t of p)m=m.replace(new RegExp(e(t),"g"),unescape(t));return m.trim()}export{n as afm};