function e(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function t(e="",t="",n=[],r=0,s=[]){let i=0,l=r;if(0===s.length||0===s.filter((e=>r>=e.start&&r<e.end)).length){const r=n.filter((t=>t.includes(e))).map((n=>{const r=t.indexOf(n,i)+n.indexOf(e);return r>i&&(i=r),r}));if(r.includes(l))for(;r.includes(l);)l=t.indexOf(e,l+1)}else l=-1;return l}function n(n="",r="extension",s=((e="")=>e),i={},l={}){const c=n.includes("\r")?"\r\n":"\n",o={skip:new Map,vids:new Map},f=Array.from(new Set(n.match(/\&#\w+;/g)||[])),a=f.map((e=>escape(e))),p=n.split(/(?<!`|>)`{3,3}(?!`)/g).filter(((e,t)=>t%2==1)).map((e=>`\`\`\`${e}\`\`\``)),d=n.match(/\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],g=Object.keys(i).filter((e=>"VIDEO"===i[e]))[0]||"VIDEO";let $=function(e=""){return JSON.parse(JSON.stringify(e))}(n),u=$;o.skip=function(e="",t=[]){const n=new Map;for(const r of t.values()){const t=e.indexOf(r),s=t+r.length;n.set(r,{start:t,end:s})}return n}($,p);for(const e of p.values())u=u.replace(e,"");const h=Array.from(o.skip.values()),m=u.match(new RegExp(`\\>\\[\\!${g}\\]\\((.*)\\)`,"g"))||[];for(const t of m.values()){const r=Array.from(n.matchAll(new RegExp(e(t),"g"))).filter((e=>{let t=!0;if(o.skip.size>0){const n=e.index;t=0===h.filter((e=>n>=e.start&&n<e.end)).length}return t})).map((e=>({start:e.index,end:e.index+e[0].length})));o.vids.set(t,r)}for(const n of d){let o=n;const a=p.filter((e=>n.includes(e)));if(a.length>0)for(const e of a)o=o.replace(e,`[AFMSKIP]${e.replace(/(^`{3,3}|`{3,3}$)/g,"")}[/AFMSKIP]`);const d=o.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),g=(d[0].match(/\>\[\!(.*)\]/)||[])[1]||"",u=d[1].replace(/\>.*/,""),m=`${c}${u}`,v=`${u}${s(d.slice(1,d.length).map((t=>{let n=t.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const t of f)n.includes(t)&&(n=n.replace(new RegExp(e(t),"g"),escape(t)));return n})).filter(((e,t)=>0!==t||e.length>0)).join(c).trim()).split(/\r?\n/).join(m)}`,x=`<div class="${r} ${(g in i?i[g]:g).toLowerCase().replace(/\s/g,"")}">${m}<div>${g in l?l[g]:g}</div>${m}<div>${c}${v.replace(/\r?\n$/,"").trimEnd()}${m}</div>${m}</div>${m}`;let w=$.indexOf(n);p.length>0&&(w=t(n,$,p,w,h)),w>0&&($=`${$.slice(0,w)}${x}${$.slice(w+n.length)}`)}for(const e of m){const n=e.replace(/^.*\(|\).*$/g,"");let s=$.indexOf(e);p.length>0&&(s=t(e,$,p,s)),$=`${$.slice(0,s)}<div class="${r} video"><iframe allowfullscreen embedded-video src="${n}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${n}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${$.slice(s+e.length)}`}for(const t of a)$=$.replace(new RegExp(e(t),"g"),unescape(t));return $.replace(/\[AFMSKIP\]/g,"<pre><code>").replace(/\[\/AFMSKIP\]/g,"</code></pre>").trim()}export{n as afm};