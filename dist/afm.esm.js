function e(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function n(e="",n="",t=[],r=0){let s=0,i=r;const l=t.filter((n=>n.includes(e))).map((t=>{const r=n.indexOf(t,s)+t.indexOf(e);return r>s&&(s=r),r}));if(l.includes(i))for(;l.includes(i);)i=n.indexOf(e,i+1);return i}function t(t="",r="extension",s=((e="")=>e),i={},l={}){const c=t.includes("\r")?"\r\n":"\n",o={skip:new Map,vids:new Map},a=Array.from(new Set(t.match(/\&#\w+;/g)||[])),p=a.map((e=>escape(e))),f=t.split(/(?<!`|>)`{3,3}(?!`)/g),d=f.filter(((e,n)=>n%2==1)).map((e=>`\`\`\`${e}\`\`\``)),g=f.filter(((e,n)=>n%2==0)).map((e=>e.replace(/(^[\r?\n]+|[\r?\n]+$)/g,""))).join(c),u=a.reduce(((n,t)=>n.replace(new RegExp(e(t),"g"),escape(t))),g),$=u.match(/(?!\r?\n)(\s+|\t+)?\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],m=Object.keys(i).filter((e=>"VIDEO"===i[e]))[0]||"VIDEO",h=u.match(new RegExp(`\\>\\[\\!${m}\\]\\((.*)\\)`,"g"))||[];let x=function(e=""){return JSON.parse(JSON.stringify(e))}(t);for(const e of d.values()){const n=t.indexOf(e),r=n+e.length;o.skip.set(e,{start:n,end:r})}const v=Array.from(o.skip.values());for(const n of h.values()){const r=Array.from(t.matchAll(new RegExp(e(n),"g"))).filter((e=>{let n=!0;if(o.skip.size>0){const t=e.index;n=0===v.filter((e=>t>=e.start&&t<e.end)).length}return n})).map((e=>({start:e.index,end:e.index+e[0].length})));o.vids.set(n,r)}for(const t of $){const f=t.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),d=(f[0].match(/\>\[\!(.*)\]/)||[])[1]||"",g=f[0].replace(/\>\[.*/,""),u=`${c}${g}`,$=`${g}${s(f.slice(1,f.length).map((n=>{let t=n.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const n of a)t.includes(n)&&(t=t.replace(new RegExp(e(n),"g"),escape(n)));return t})).filter(((e,n)=>0!==n||e.length>0)).join(c).trim()).split(/\r?\n/).join(u)}`,m=(d in i?i[d]:d).toLowerCase().replace(/\s/g,""),h=f.map((n=>{let t=n;for(const n of p)t.includes(n)&&(t=t.replace(new RegExp(e(n),"g"),unescape(n)));return t})).join(c),v=Array.from(o.skip.keys()).filter((e=>e.includes(h)));let w=x.indexOf(h);v.length>0&&(w=n(h,x,v,w)),x=`${x.slice(0,w)}${g}<div class="${r} ${m}">${u}<div>${d in l?l[d]:d}</div>${u}<div>${c}${$.replace(/\r?\n$/,"")}${u}</div>${u}</div>${u}${x.slice(w+h.length)}`}for(const e of h){const t=e.replace(/^.*\(|\).*$/g,"");let s=x.indexOf(e);d.length>0&&(s=n(e,x,d,s)),x=`${x.slice(0,s)}<div class="${r} video"><iframe allowfullscreen embedded-video src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${t}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${x.slice(s+e.length)}`}for(const n of p)x=x.replace(new RegExp(e(n),"g"),unescape(n));return x.trim()}export{t as afm};