function e(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function n(e="",n="",t=[],r=0){let i=0,s=r;const l=t.filter((n=>n.includes(e))).map((t=>{const r=n.indexOf(t,i)+t.indexOf(e);return r>i&&(i=r),r}));if(l.includes(s))for(;l.includes(s);)s=n.indexOf(e,s+1);return s}function t(t="",r="extension",i=((e="")=>e),s={},l={}){const o=t.includes("\r")?"\r\n":"\n",c={skip:new Map,vids:new Map},a=Array.from(new Set(t.match(/\&#\w+;/g)||[])),p=a.map((e=>escape(e))),f=t.split(/(?<!`|>)`{3,3}(?!`)/g),d=f.filter(((e,n)=>n%2==1)).map((e=>`\`\`\`${e}\`\`\``)),g=f.filter(((e,n)=>n%2==0)).map((e=>e.replace(/(^[\r?\n]+|[\r?\n]+$)/g,""))).join(o),u=a.reduce(((n,t)=>n.replace(new RegExp(e(t),"g"),escape(t))),g),$=u.match(/(?!\r?\n)(\s+|\t+)?\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],m=Object.keys(s).filter((e=>"VIDEO"===s[e]))[0]||"VIDEO",h=u.match(new RegExp(`\\>\\[\\!${m}\\]\\((.*)\\)`,"g"))||[];let x=function(e=""){return JSON.parse(JSON.stringify(e))}(t);for(const e of d.values()){const n=t.indexOf(e),r=n+e.length;c.skip.set(e,{start:n,end:r})}const w=Array.from(c.skip.values());for(const n of h.values()){const r=Array.from(t.matchAll(new RegExp(e(n),"g"))).filter((e=>{let n=!0;if(c.skip.size>0){const t=e.index;n=0===w.filter((e=>t>=e.start&&t<e.end)).length}return n})).map((e=>({start:e.index,end:e.index+e[0].length})));c.vids.set(n,r)}for(const t of $){const c=t.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),f=(c[0].match(/\>\[\!(.*)\]/)||[])[1]||"",g=c[0].replace(/\>\[.*/,""),u=`${o}${g}`,$=`${g}${i(c.slice(1,c.length).map((n=>{let t=n.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const n of a)t.includes(n)&&(t=t.replace(new RegExp(e(n),"g"),escape(n)));return t})).filter(((e,n)=>0!==n||e.length>0)).join(o).trim()).split(/\r?\n/).join(u)}`,m=(f in s?s[f]:f).toLowerCase().replace(/\s/g,""),h=c.map((n=>{let t=n;for(const n of p)t.includes(n)&&(t=t.replace(new RegExp(e(n),"g"),unescape(n)));return t})).join(o);let w=x.indexOf(h);if(d.length>0&&(w=n(h,x,d,w)),-1===w)throw new Error(`Could not find string: ${h}`);x=`${x.slice(0,w)}${g}<div class="${r} ${m}">${u}<div>${f in l?l[f]:f}</div>${u}<div>${o}${$.replace(/\r?\n$/,"")}${u}</div>${u}</div>${u}${x.slice(w+h.length)}`}for(const e of h){const t=e.replace(/^.*\(|\).*$/g,"");let i=x.indexOf(e);d.length>0&&(i=n(e,x,d,i)),x=`${x.slice(0,i)}<div class="${r} video"><iframe allowfullscreen embedded-video src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${t}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${x.slice(i+e.length)}`}for(const n of p)x=x.replace(new RegExp(e(n),"g"),unescape(n));return x.trim()}export{t as afm};