!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).afm={})}(this,(function(e){"use strict";function n(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function t(e="",n="",t=[],r=0){let i=0,s=r;const o=t.filter((n=>n.includes(e))).map((t=>{const r=n.indexOf(t,i)+t.indexOf(e);return r>i&&(i=r),r}));if(o.includes(s))for(;o.includes(s);)s=n.indexOf(e,s+1);return s}e.afm=function(e="",r="extension",i=((e="")=>e),s={},o={}){const l=e.includes("\r")?"\r\n":"\n",c={skip:new Map,vids:new Map},f=Array.from(new Set(e.match(/\&#\w+;/g)||[])),a=f.map((e=>escape(e))),p=e.split(/(?<!`|>)`{3,3}(?!`)/g),d=p.filter(((e,n)=>n%2==1)).map((e=>`\`\`\`${e}\`\`\``)),u=p.filter(((e,n)=>n%2==0)).map((e=>e.replace(/(^[\r?\n]+|[\r?\n]+$)/g,""))).join(l),g=f.reduce(((e,t)=>e.replace(new RegExp(n(t),"g"),escape(t))),u),$=g.match(/(?!\r?\n)(\s+|\t+)?\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],m=Object.keys(s).filter((e=>"VIDEO"===s[e]))[0]||"VIDEO",h=g.match(new RegExp(`\\>\\[\\!${m}\\]\\((.*)\\)`,"g"))||[];let x=function(e=""){return JSON.parse(JSON.stringify(e))}(e);for(const n of d.values()){const t=e.indexOf(n),r=t+n.length;c.skip.set(n,{start:t,end:r})}const v=Array.from(c.skip.values());for(const t of h.values()){const r=Array.from(e.matchAll(new RegExp(n(t),"g"))).filter((e=>{let n=!0;if(c.skip.size>0){const t=e.index;n=0===v.filter((e=>t>=e.start&&t<e.end)).length}return n})).map((e=>({start:e.index,end:e.index+e[0].length})));c.vids.set(t,r)}for(const e of $){const c=e.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),p=(c[0].match(/\>\[\!(.*)\]/)||[])[1]||"",u=c[0].replace(/\>\[.*/,""),g=`${l}${u}`,$=`${u}${i(c.slice(1,c.length).map((e=>{let t=e.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const e of f)t.includes(e)&&(t=t.replace(new RegExp(n(e),"g"),escape(e)));return t})).filter(((e,n)=>0!==n||e.length>0)).join(l).trim()).split(/\r?\n/).join(g)}`,m=(p in s?s[p]:p).toLowerCase().replace(/\s/g,""),h=c.map((e=>{let t=e;for(const e of a)t.includes(e)&&(t=t.replace(new RegExp(n(e),"g"),unescape(e)));return t})).join(l);let v=x.indexOf(h);if(d.length>0&&(v=t(h,x,d,v)),-1===v)throw new Error(`Could not find string: ${h}`);x=`${x.slice(0,v)}${u}<div class="${r} ${m}">${g}<div>${p in o?o[p]:p}</div>${g}<div>${l}${$.replace(/\r?\n$/,"")}${g}</div>${g}</div>${g}${x.slice(v+h.length)}`}for(const e of h){const n=e.replace(/^.*\(|\).*$/g,"");let i=x.indexOf(e);d.length>0&&(i=t(e,x,d,i)),x=`${x.slice(0,i)}<div class="${r} video"><iframe allowfullscreen embedded-video src="${n}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${n}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${x.slice(i+e.length)}`}for(const e of a)x=x.replace(new RegExp(n(e),"g"),unescape(e));return x.trim()},Object.defineProperty(e,"__esModule",{value:!0})}));