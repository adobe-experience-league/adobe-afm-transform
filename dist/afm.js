!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).afm={})}(this,(function(e){"use strict";function t(e=""){return e.replace(/[\-\[\]{}()*+?.,\\\^\$|#]/g,"\\$&")}function n(e="",t=[]){const n=new Map;for(const r of t.values()){const t=e.indexOf(r),s=t+r.length;n.set(r,{start:t,end:s})}return n}function r(e="",t="",n=[],r=0,s={skip:new Map}){const i=Array.from(s.skip.values());let l=0,o=r;if(0===i.length||0===i.filter((e=>r>=e.start&&r<e.end)).length){const r=n.filter((t=>t.includes(e))).map((n=>{const r=t.indexOf(n,l)+n.indexOf(e);return r>l&&(l=r),r}));if(r.includes(o))for(;r.includes(o);)o=t.indexOf(e,o+1)}else o=-1;return o}e.afm=function(e="",s="extension",i=((e="")=>e),l={},o={}){const c=e.includes("\r")?"\r\n":"\n",f={skip:new Map,vids:new Map},a=Array.from(new Set(e.match(/\&#\w+;/g)||[])),p=a.map((e=>escape(e))),d=e.split(/(?<!`|>)`{3,3}(?!`)/g).filter(((e,t)=>t%2==1)).map((e=>`\`\`\`${e}\`\`\``)),u=e.match(/\>\[\!.*\r?\n((\s+|\t+)?\>(?!\[\!).*\r?\n?){1,}/g)||[],g=Object.keys(l).filter((e=>"VIDEO"===l[e]))[0]||"VIDEO";let $=function(e=""){return JSON.parse(JSON.stringify(e))}(e),m=$;f.skip=n($,d);for(const e of d.values())m=m.replace(e,"");const h=Array.from(f.skip.values()),v=m.match(new RegExp(`\\>\\[\\!${g}\\]\\((.*)\\)`,"g"))||[];for(const n of v.values()){const r=Array.from(e.matchAll(new RegExp(t(n),"g"))).filter((e=>{let t=!0;if(f.skip.size>0){const n=e.index;t=0===h.filter((e=>n>=e.start&&n<e.end)).length}return t})).map((e=>({start:e.index,end:e.index+e[0].length})));f.vids.set(n,r)}for(const e of u){let p=e;const u=d.filter((t=>e.includes(t)));if(u.length>0)for(const e of u)p=p.replace(e,`[AFMSKIP]${e.replace(/(^`{3,3}|`{3,3}$)/g,"")}[/AFMSKIP]`);const g=p.split(/\r?\n/).filter((e=>e.length>0&&/[^\s]+/.test(e))),m=(g[0].match(/\>\[\!(.*)\]/)||[])[1]||"",h=g[1].replace(/\>.*/,""),v=`${c}${h}`,x=`${h}${i(g.slice(1,g.length).map((e=>{let n=e.replace(/^(\s+|\t+)?\>/,"").trimEnd();for(const e of a)n.includes(e)&&(n=n.replace(new RegExp(t(e),"g"),escape(e)));return n})).filter(((e,t)=>0!==t||e.length>0)).join(c).trim()).split(/\r?\n/).join(v)}`,w=`<div class="${s} ${(m in l?l[m]:m).toLowerCase().replace(/\s/g,"")}">${v}<div>${m in o?o[m]:m}</div>${v}<div>${c}${x.replace(/\r?\n$/,"").trimEnd()}${v}</div>${v}</div>${v}`;let y=$.indexOf(e);d.length>0&&(y=r(e,$,d,y,f)),y>0&&($=`${$.slice(0,y)}${w}${$.slice(y+e.length)}`,f.skip=n($,d))}for(const e of v){const t=e.replace(/^.*\(|\).*$/g,"");let n=$.indexOf(e);d.length>0&&(n=r(e,$,d,n)),$=`${$.slice(0,n)}<div class="${s} video"><iframe allowfullscreen embedded-video src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"><source src="${t}" type="" /><p>Your browser does not support the iframe element.</p></iframe></div>${$.slice(n+e.length)}`}for(const e of p)$=$.replace(new RegExp(t(e),"g"),unescape(e));return $.replace(/\[AFMSKIP\]/g,"<pre><code>").replace(/\[\/AFMSKIP\]/g,"</code></pre>").trim()},Object.defineProperty(e,"__esModule",{value:!0})}));